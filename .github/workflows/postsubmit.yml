name: Postsubmit

on:
  schedule:
    - cron: "0 4 * * *" # Once a day at 4am.
  # Manual runs through Actions tab in the UI
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  call-bazel:
    uses: ./.github/workflows/check-bazel.yml

  integration-test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # tag=v3.1.0
      - name: Auth
        uses: google-github-actions/auth@5a50e581162a13f4baa8916d01180d2acbc04363 # tag=v2.1.0
        with:
          create_credentials_file: true # also sets GOOGLE_APPLICATION_CREDENTIALS
          service_account: "github-automation-bot@gha-crc-dev.iam.gserviceaccount.com"
          workload_identity_provider: "projects/1043719249528/locations/global/workloadIdentityPools/github-automation/providers/crc-dev"
      - name: "Set up gcloud"
        uses: "google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200" # tag=v2.1.0
        with:
          skip_install: true
      - id: "get-credentials"
        uses: "google-github-actions/get-gke-credentials@c02be8662df01db62234e9b9cff0765d1c1827ae" # tag=v2.1.0
        with:
          project_id: "robco-integration-test"
          cluster_name: "cloud-robotics"
          location: "europe-west1-c"
      - name: Run integration_test.sh
        env:
          MANUAL_RUN: "${{ github.event_name == 'workflow_dispatch' }}"
        run: ./.github/ci/integration_test.sh
