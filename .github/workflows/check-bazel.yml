name: Check Bazel

on:
  workflow_call:

permissions:
  contents: read
  id-token: write

env:
  USE_BAZEL_VERSION: "6.3.2"

jobs:
  check-bazel:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # tag=v3.3.0
      - name: Auth
        uses: google-github-actions/auth@5a50e581162a13f4baa8916d01180d2acbc04363 # tag=v2.1.0
        with:
          create_credentials_file: true # also sets GOOGLE_APPLICATION_CREDENTIALS
          service_account: "github-automation-bot@gha-crc-dev.iam.gserviceaccount.com"
          workload_identity_provider: "projects/1043719249528/locations/global/workloadIdentityPools/github-automation/providers/crc-dev"
      - name: Print error on auth fail
        if: failure()
        run: |
          echo >&2 "This PR appears to be from a fork or authored by a non-org member, rather than from the primary repo."
          echo >&2 "This means it can't run the presubmit, which requires access to GCR."
          echo >&2 "If you are a project member, please push your branch to github.com/googlecloudrobotics/core instead."
          exit 1
      - name: Run .github/ci/presubmit.sh
        run: ./.github/ci/presubmit.sh
      - name: Get bazel server logs
        if: success() || failure()
        run: cat ~/.cache/bazel/_bazel_*/*/java.log || true
