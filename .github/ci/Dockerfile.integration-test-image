# Image used for integration_test.sh on Cloud Build.
# Allows access to GKE and to run Bazel commands.
FROM gcr.io/cloud-builders/kubectl

# Install Bazelisk
RUN \
    VERSION="v1.19.0" # check latest version in https://github.com/bazelbuild/bazelisk/releases \
    curl -L https://github.com/bazelbuild/bazelisk/releases/download/$VERSION/bazelisk-linux-amd64 --output /usr/bin/bazelisk \
    chmod +x /usr/bin/bazelisk \
    ln -s /usr/bin/bazelisk /usr/bin/bazel

# Install crictl, needed for setup-robot.sh
# From https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md.
RUN \
    VERSION="v1.29.0" # check latest version in https://github.com/kubernetes-sigs/cri-tools/releases \
    curl -L https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-${VERSION}-linux-amd64.tar.gz --output crictl-${VERSION}-linux-amd64.tar.gz \
    tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C /usr/bin \
    rm -f crictl-$VERSION-linux-amd64.tar.gz

RUN mkdir -p /builder /output /workspace && chmod -R 777 /output

# rules_python is not happy if bazel runs as root so create a new user
# https://github.com/bazelbuild/rules_python/pull/713
# https://github.com/GoogleCloudPlatform/cloud-builders/issues/641
RUN adduser builder

# Allow running sudo without password
RUN apt-get update && apt-get install -y sudo && apt-get clean && rm -rf /var/lib/apt/lists/* && \
    usermod -aG sudo builder && \
    echo "builder ALL=(ALL) NOPASSWD:ALL" > "/etc/sudoers.d/builder" && chmod 440 "/etc/sudoers.d/builder"

USER builder
